import { type NextRequest, NextResponse } from "next/server"
import { generateObject } from "ai"
import { openai } from "@ai-sdk/openai"
import { z } from "zod"

import { initializeApp, getApps, cert } from "firebase-admin/app"
import { getAuth } from "firebase-admin/auth"

// Initialize Firebase Admin
const initializeFirebaseAdmin = () => {
  if (getApps().length === 0) {
    initializeApp({
      credential: cert({
        projectId: process.env.FIREBASE_PROJECT_ID,
        clientEmail: process.env.FIREBASE_CLIENT_EMAIL,
        privateKey: process.env.FIREBASE_PRIVATE_KEY?.replace(/\\n/g, "\n"),
      }),
    })
  }
}

// Middleware para verificar token JWT
const verifyAuthToken = async (request: NextRequest) => {
  try {
    const authHeader = request.headers.get("authorization")

    if (!authHeader || !authHeader.startsWith("Bearer ")) {
      return { success: false, error: "Token de autorizaci√≥n requerido", status: 401 }
    }

    const token = authHeader.replace("Bearer ", "")

    if (!token) {
      return { success: false, error: "Token no v√°lido", status: 401 }
    }

    // Initialize Firebase Admin if not already done
    initializeFirebaseAdmin()

    // Verify the token
    const decodedToken = await getAuth().verifyIdToken(token)

    return { success: true, uid: decodedToken.uid, decodedToken }
  } catch (error: any) {
    console.error("Error verificando token:", error)

    let errorMessage = "Token inv√°lido"
    if (error.code === "auth/id-token-expired") {
      errorMessage = "Token expirado"
    } else if (error.code === "auth/id-token-revoked") {
      errorMessage = "Token revocado"
    }

    return { success: false, error: errorMessage, status: 401 }
  }
}

// Schema para generar preguntas adaptativas
const PreguntaSchema = z.object({
  pregunta: z.string().describe("La pregunta, tema de debate o desaf√≠o adaptado al arquetipo del estudiante"),
  opciones: z.array(z.string()).describe("4 opciones de respuesta, argumentos o estrategias de equipo").optional(),
  respuestaCorrecta: z.string().describe("La respuesta correcta, posici√≥n ganadora o soluci√≥n del equipo").optional(),
  explicacion: z.string().describe("Explicaci√≥n educativa de la respuesta o reflexi√≥n del debate"),
  puntaje: z.number().describe("Puntos que otorga (15-50)"),
  tiempoSugerido: z.number().describe("Tiempo sugerido en segundos"),
  nivelDificultad: z.enum(["f√°cil", "medio", "dif√≠cil"]).describe("Nivel de dificultad"),
  habilidadCognitiva: z
    .enum(["recordar", "comprender", "aplicar", "analizar", "evaluar", "crear"])
    .describe("Habilidad cognitiva seg√∫n Bloom"),
  tipoJuego: z.enum(["trivia", "debate", "equipo"]).describe("Tipo de minijuego"),
  equiposRequeridos: z.number().describe("N√∫mero de equipos para juegos colaborativos").optional(),
  argumentos: z.array(z.string()).describe("Argumentos base para debates").optional(),
  tareas: z.array(z.string()).describe("Tareas espec√≠ficas para trabajo en equipo").optional(),
})

export async function GET(request: NextRequest) {
  // Verificar token de autenticaci√≥n
  const authResult = await verifyAuthToken(request)
  if (!authResult.success) {
    return NextResponse.json({ success: false, error: authResult.error }, { status: authResult.status })
  }

  // El usuario est√° autenticado, continuar con la l√≥gica original
  const { uid } = authResult

  // Resto de la l√≥gica original...
  try {
    const { searchParams } = new URL(request.url)
    const arquetipo = searchParams.get("arquetipo") || "gamer"
    const materia = searchParams.get("materia") || "Matem√°ticas"
    const tema = searchParams.get("tema") || ""
    const dificultad = searchParams.get("dificultad") || "medio"

    // Si no hay API key o hay problemas, usar datos simulados mejorados
    if (!process.env.OPENAI_API_KEY || process.env.OPENAI_API_KEY.trim() === "") {
      console.log("OpenAI API key no configurada, generando pregunta simulada inteligente")
      return generarPreguntaSimulada(arquetipo, materia, tema, dificultad)
    }

    try {
      // Definir caracter√≠sticas de cada arquetipo
      const arquetipos = {
        gamer: {
          descripcion: "Le gustan los desaf√≠os, la competencia sana, elementos de juego, progresi√≥n clara",
          estilo: "Preguntas con narrativa de desaf√≠o, elementos de 'misi√≥n', lenguaje din√°mico",
        },
        creativo: {
          descripcion: "Prefiere expresi√≥n personal, conexiones innovadoras, m√∫ltiples perspectivas",
          estilo: "Preguntas abiertas, que permitan creatividad, con contextos imaginativos",
        },
        anal√≠tico: {
          descripcion: "Disfruta del pensamiento l√≥gico, resoluci√≥n de problemas, an√°lisis detallado",
          estilo: "Preguntas que requieren razonamiento paso a paso, an√°lisis de datos, l√≥gica",
        },
        social: {
          descripcion: "Aprende mejor en contextos colaborativos, situaciones reales, impacto social",
          estilo: "Preguntas con contexto social, trabajo en equipo, aplicaciones del mundo real",
        },
        debatidor: {
          descripcion: "Disfruta la argumentaci√≥n, el an√°lisis cr√≠tico, la persuasi√≥n y el intercambio de ideas",
          estilo: "Preguntas controvertidas, an√°lisis de perspectivas m√∫ltiples, construcci√≥n de argumentos",
        },
        colaborativo: {
          descripcion:
            "Aprende mejor trabajando en equipo, resolviendo problemas grupales, compartiendo responsabilidades",
          estilo: "Desaf√≠os que requieren colaboraci√≥n, roles espec√≠ficos, objetivos compartidos",
        },
      }

      const arquetipoInfo = arquetipos[arquetipo as keyof typeof arquetipos] || arquetipos.gamer

      let prompt = `Genera una pregunta educativa para un estudiante de secundaria con las siguientes caracter√≠sticas:

MATERIA: ${materia}
TEMA ESPEC√çFICO: ${tema || "Conceptos generales de " + materia}
ARQUETIPO DEL ESTUDIANTE: ${arquetipo}
- Descripci√≥n: ${arquetipoInfo.descripcion}
- Estilo preferido: ${arquetipoInfo.estilo}

NIVEL DE DIFICULTAD: ${dificultad}

INSTRUCCIONES:
1. Crea una pregunta que se adapte perfectamente al estilo de aprendizaje del arquetipo
2. Aseg√∫rate de que sea educativamente valiosa y no trivial
3. Las opciones deben ser plausibles pero con una respuesta claramente correcta
4. La explicaci√≥n debe ser clara y educativa
5. Adapta el lenguaje y contexto al arquetipo del estudiante

EJEMPLO PARA GAMER: "üéÆ MISI√ìN: Resuelve este desaf√≠o matem√°tico para desbloquear el siguiente nivel..."
EJEMPLO PARA CREATIVO: "üé® Imagina que eres un artista que necesita calcular las proporciones perfectas..."
EJEMPLO PARA ANAL√çTICO: "üîç Analiza los siguientes datos y determina la soluci√≥n m√°s l√≥gica..."
EJEMPLO PARA SOCIAL: "üë• En tu comunidad se presenta esta situaci√≥n, ¬øc√≥mo la resolver√≠as?..."`

      if (arquetipo === "debatidor" || dificultad === "debate") {
        prompt += `

FORMATO ESPECIAL PARA DEBATE:
- Presenta un tema controvertido pero educativo
- Proporciona argumentos base para ambas posiciones
- Fomenta el pensamiento cr√≠tico y la argumentaci√≥n estructurada
- Incluye preguntas que eval√∫en la calidad de los argumentos
- Ejemplo: "üèõÔ∏è GRAN DEBATE: ¬øDeber√≠an las redes sociales ser reguladas por el gobierno?"`
      }

      if (arquetipo === "colaborativo" || dificultad === "equipo") {
        prompt += `

FORMATO ESPECIAL PARA TRABAJO EN EQUIPO:
- Crea un desaf√≠o que requiera colaboraci√≥n entre estudiantes
- Divide el problema en tareas espec√≠ficas para cada miembro
- Incluye objetivos compartidos y m√©tricas de √©xito grupal
- Fomenta la comunicaci√≥n y coordinaci√≥n entre miembros
- Ejemplo: "üë• MISI√ìN DE EQUIPO: Dise√±en una ciudad sostenible asignando roles espec√≠ficos"`
      }

      console.log(`Intentando generar pregunta para arquetipo ${arquetipo} en ${materia}`)

      const { object: pregunta } = await generateObject({
        model: openai("gpt-4o-mini"),
        schema: PreguntaSchema,
        prompt: prompt,
        temperature: 0.8,
      })

      console.log("Pregunta generada exitosamente con OpenAI")

      return NextResponse.json({
        success: true,
        id: Math.floor(Math.random() * 10000),
        materia,
        arquetipo,
        tema,
        ...pregunta,
        generadoPorIA: true,
        fechaGeneracion: new Date().toISOString(),
      })
    } catch (aiError: any) {
      console.error("Error espec√≠fico de OpenAI:", aiError.message)

      // Manejar errores espec√≠ficos y usar fallback inteligente
      let errorType = "api_error"

      if (
        aiError.message?.includes("quota") ||
        aiError.message?.includes("billing") ||
        aiError.message?.includes("exceeded")
      ) {
        console.log("Cuota de OpenAI excedida, usando generaci√≥n simulada inteligente")
        errorType = "quota_exceeded"
      } else if (aiError.message?.includes("rate limit")) {
        console.log("Rate limit de OpenAI alcanzado, usando generaci√≥n simulada")
        errorType = "rate_limit"
      } else if (aiError.message?.includes("API key") || aiError.message?.includes("authentication")) {
        console.log("Error de API key de OpenAI, usando generaci√≥n simulada")
        errorType = "api_key_error"
      } else {
        console.log("Error general de OpenAI, usando generaci√≥n simulada")
        errorType = "api_error"
      }

      return generarPreguntaSimulada(arquetipo, materia, tema, dificultad, errorType)
    }
  } catch (error) {
    console.error("Error general obteniendo minijuego:", error)
    return generarPreguntaSimulada("gamer", "Matem√°ticas", "", "medio")
  }
}
// Funci√≥n mejorada para generar preguntas simuladas m√°s inteligentes
function generarPreguntaSimulada(
  arquetipo: string,
  materia: string,
  tema = "",
  dificultad = "medio",
  errorType?: string,
) {
  const preguntasInteligentes = {
    gamer: {
      Matem√°ticas: [
        {
          pregunta:
            "üéÆ DESAF√çO MATEM√ÅTICO: Un jugador tiene 150 monedas y gasta 3/5 en mejoras. ¬øCu√°ntas monedas le quedan para el siguiente nivel?",
          opciones: ["90 monedas", "60 monedas", "100 monedas", "75 monedas"],
          respuestaCorrecta: "60 monedas",
          explicacion: "150 √ó 3/5 = 90 monedas gastadas. 150 - 90 = 60 monedas restantes. ¬°Misi√≥n completada! üèÜ",
          habilidadCognitiva: "aplicar",
          tipoJuego: "trivia",
        },
        {
          pregunta:
            "üéØ BOSS BATTLE: Para derrotar al jefe final necesitas resolver: Si x¬≤ - 5x + 6 = 0, ¬øcu√°les son los valores de x?",
          opciones: ["x = 2, x = 3", "x = 1, x = 6", "x = -2, x = -3", "x = 0, x = 5"],
          respuestaCorrecta: "x = 2, x = 3",
          explicacion: "Factorizando: (x-2)(x-3) = 0, entonces x = 2 o x = 3. ¬°Boss derrotado! üí™",
          habilidadCognitiva: "analizar",
          tipoJuego: "trivia",
        },
      ],
      Historia: [
        {
          pregunta:
            "‚öîÔ∏è BATALLA HIST√ìRICA: En 1939 comenz√≥ una guerra que cambi√≥ el mundo. ¬øCu√°l fue el evento que activ√≥ este conflicto global?",
          opciones: ["Invasi√≥n de Polonia", "Ataque a Pearl Harbor", "Batalla de Francia", "Operaci√≥n Barbarroja"],
          respuestaCorrecta: "Invasi√≥n de Polonia",
          explicacion:
            "La invasi√≥n alemana de Polonia el 1 de septiembre de 1939 fue el evento que desencaden√≥ la Segunda Guerra Mundial. ¬°Historia desbloqueada! üìö",
          habilidadCognitiva: "recordar",
          tipoJuego: "trivia",
        },
      ],
      Literatura: [
        {
          pregunta:
            "üìñ QUEST LITERARIA: En el universo de Garc√≠a M√°rquez, ¬øqu√© obra maestra narra la saga de los Buend√≠a?",
          opciones: [
            "Cien a√±os de soledad",
            "El amor en los tiempos del c√≥lera",
            "Cr√≥nica de una muerte anunciada",
            "La hojarasca",
          ],
          respuestaCorrecta: "Cien a√±os de soledad",
          explicacion:
            "'Cien a√±os de soledad' es la obra cumbre que narra la historia de la familia Buend√≠a en Macondo. ¬°Logro literario desbloqueado! üèÖ",
          habilidadCognitiva: "recordar",
          tipoJuego: "trivia",
        },
      ],
    },
    creativo: {
      Literatura: [
        {
          pregunta:
            "üé® CREATIVIDAD LITERARIA: Si fueras a reescribir Romeo y Julieta en el siglo XXI, ¬øqu√© elemento ser√≠a el equivalente moderno del balc√≥n?",
          opciones: ["Redes sociales", "Videollamadas", "Mensajes de texto", "Todas las anteriores"],
          respuestaCorrecta: "Todas las anteriores",
          explicacion:
            "La tecnolog√≠a moderna ofrece m√∫ltiples formas de comunicaci√≥n √≠ntima que pueden recrear la magia del balc√≥n cl√°sico. ¬°Tu creatividad no tiene l√≠mites! ‚ú®",
          habilidadCognitiva: "crear",
          tipoJuego: "trivia",
        },
      ],
      Matem√°ticas: [
        {
          pregunta:
            "üé≠ ARTE MATEM√ÅTICO: Un artista quiere crear un mural con proporciones √°ureas. Si la base mide 8 metros, ¬øcu√°nto debe medir la altura?",
          opciones: ["4.94 metros", "12.94 metros", "6.18 metros", "10 metros"],
          respuestaCorrecta: "4.94 metros",
          explicacion:
            "La proporci√≥n √°urea es aproximadamente 1.618. Entonces 8 √∑ 1.618 ‚âà 4.94 metros. ¬°Arte y matem√°ticas en perfecta armon√≠a! üé®",
          habilidadCognitiva: "aplicar",
          tipoJuego: "trivia",
        },
      ],
    },
    anal√≠tico: {
      Ciencias: [
        {
          pregunta:
            "üî¨ AN√ÅLISIS CIENT√çFICO: Si la densidad del agua es 1 g/cm¬≥ y un objeto flota, ¬øqu√© puedes concluir sobre su densidad?",
          opciones: ["Es mayor que 1 g/cm¬≥", "Es menor que 1 g/cm¬≥", "Es igual a 1 g/cm¬≥", "No se puede determinar"],
          respuestaCorrecta: "Es menor que 1 g/cm¬≥",
          explicacion:
            "Por el principio de Arqu√≠medes, un objeto flota cuando su densidad es menor que la del fluido. An√°lisis correcto! üß™",
          habilidadCognitiva: "analizar",
          tipoJuego: "trivia",
        },
      ],
      Matem√°ticas: [
        {
          pregunta:
            "üìä AN√ÅLISIS DE DATOS: Observa la secuencia: 2, 6, 18, 54... ¬øCu√°l es el patr√≥n y el siguiente t√©rmino?",
          opciones: [
            "Multiplicar por 3; siguiente: 162",
            "Sumar 4; siguiente: 58",
            "Multiplicar por 2; siguiente: 108",
            "Sumar m√∫ltiplos de 4; siguiente: 70",
          ],
          respuestaCorrecta: "Multiplicar por 3; siguiente: 162",
          explicacion:
            "Cada t√©rmino se multiplica por 3: 2√ó3=6, 6√ó3=18, 18√ó3=54, 54√ó3=162. ¬°Patr√≥n identificado correctamente! üéØ",
          habilidadCognitiva: "analizar",
          tipoJuego: "trivia",
        },
      ],
    },
    debatidor: {
      Historia: [
        {
          pregunta: "üèõÔ∏è GRAN DEBATE: ¬øLa Revoluci√≥n Francesa fue m√°s beneficiosa o perjudicial para la sociedad?",
          tipoJuego: "debate",
          argumentos: [
            "A favor: Estableci√≥ derechos fundamentales y elimin√≥ privilegios aristocr√°ticos",
            "En contra: Caus√≥ violencia extrema y inestabilidad social prolongada",
          ],
          explicacion:
            "Ambas perspectivas tienen m√©rito hist√≥rico. La evaluaci√≥n debe considerar consecuencias a corto y largo plazo.",
          habilidadCognitiva: "evaluar",
        },
      ],
      Literatura: [
        {
          pregunta: "üìö DEBATE LITERARIO: ¬øLos finales abiertos en las novelas son superiores a los finales cerrados?",
          tipoJuego: "debate",
          argumentos: [
            "Finales abiertos: Permiten interpretaci√≥n personal y reflexi√≥n continua",
            "Finales cerrados: Proporcionan satisfacci√≥n narrativa y resoluci√≥n completa",
          ],
          explicacion: "La efectividad depende del prop√≥sito narrativo y la experiencia que busca crear el autor.",
          habilidadCognitiva: "evaluar",
        },
      ],
    },
    colaborativo: {
      Ciencias: [
        {
          pregunta: "üî¨ PROYECTO DE EQUIPO: Dise√±en un experimento para probar la calidad del agua local",
          tipoJuego: "equipo",
          equiposRequeridos: 4,
          tareas: [
            "Investigador: Buscar m√©todos de an√°lisis de agua",
            "Experimentador: Dise√±ar el procedimiento",
            "Analista: Interpretar resultados",
            "Comunicador: Presentar hallazgos",
          ],
          explicacion:
            "El trabajo en equipo permite abordar problemas complejos desde m√∫ltiples perspectivas especializadas.",
          habilidadCognitiva: "crear",
        },
      ],
      Matem√°ticas: [
        {
          pregunta: "üìä DESAF√çO GRUPAL: Calculen el presupuesto para un evento escolar con $500",
          tipoJuego: "equipo",
          equiposRequeridos: 3,
          tareas: [
            "Contador: Calcular costos de comida y bebidas",
            "Coordinador: Estimar gastos de decoraci√≥n y entretenimiento",
            "Tesorero: Balancear el presupuesto final",
          ],
          explicacion: "La planificaci√≥n financiera colaborativa ense√±a responsabilidad y matem√°ticas aplicadas.",
          habilidadCognitiva: "aplicar",
        },
      ],
    },
  }

  // Seleccionar pregunta basada en arquetipo y materia
  const preguntasPorArquetipo =
    preguntasInteligentes[arquetipo as keyof typeof preguntasInteligentes] || preguntasInteligentes.gamer
  const preguntasPorMateria =
    preguntasPorArquetipo[materia as keyof typeof preguntasPorArquetipo] ||
    Object.values(preguntasPorArquetipo)[0] ||
    []

  const preguntaSeleccionada =
    Array.isArray(preguntasPorMateria) && preguntasPorMateria.length > 0
      ? preguntasPorMateria[Math.floor(Math.random() * preguntasPorMateria.length)]
      : {
          pregunta: `¬øCu√°l es un concepto importante en ${materia}?`,
          opciones: ["Concepto A", "Concepto B", "Concepto C", "Concepto D"],
          respuestaCorrecta: "Concepto A",
          explicacion: `Este es un concepto fundamental en ${materia}.`,
          habilidadCognitiva: "comprender",
          tipoJuego: "trivia",
        }

  // Ajustar puntaje seg√∫n dificultad
  const puntajeBase = {
    f√°cil: 20,
    medio: 30,
    dif√≠cil: 40,
  }

  // Mensajes m√°s informativos seg√∫n el tipo de error
  const mensajes = {
    quota_exceeded: "ü§ñ Modo Simulado Activo - Cuota de OpenAI temporalmente excedida. ¬°Sigue jugando!",
    rate_limit: "ü§ñ Modo Simulado Activo - L√≠mite de velocidad de OpenAI alcanzado. ¬°Contenido igual de bueno!",
    api_key_error: "ü§ñ Modo Simulado Activo - Configuraci√≥n de API pendiente. ¬°Experiencia completa disponible!",
    api_error: "ü§ñ Modo Simulado Activo - Error temporal de IA. ¬°Preguntas inteligentes disponibles!",
    general_error: "ü§ñ Modo Simulado Activo - Funcionando offline. ¬°Diversi√≥n garantizada!",
    default: "ü§ñ Modo Simulado Activo - Configura OPENAI_API_KEY para IA real",
  }

  return NextResponse.json({
    success: true,
    id: Math.floor(Math.random() * 1000),
    materia,
    arquetipo,
    tema: tema || `Conceptos de ${materia}`,
    ...preguntaSeleccionada,
    puntaje: puntajeBase[dificultad as keyof typeof puntajeBase] || 25,
    tiempoSugerido: 30,
    nivelDificultad: dificultad,
    generadoPorIA: false,
    simuladorInteligente: true,
    nota: mensajes[errorType as keyof typeof mensajes] || mensajes.default,
  })
}
